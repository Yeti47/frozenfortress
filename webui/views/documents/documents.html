{{template "header" .}}
    <style>
        /* Override body and main content layout for better space utilization */
        body {
            min-height: 100vh !important;
            height: auto !important;
            overflow: auto !important;
        }
        
        .main-content {
            align-items: flex-start !important;
            padding: 20px 15px !important;
            flex: 1 !important;
            min-height: calc(100vh - 200px) !important; /* Account for header, nav, and footer */
            overflow: visible !important;
        }
        
        .content-container {
            max-width: 1400px !important;
            padding: 30px !important;
            margin: 0 auto;
            min-height: calc(100vh - 240px); /* Account for header, nav, footer, and margins */
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .documents-container {
            width: 100%;
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .documents-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .documents-title {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .documents-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding-top: 3px;
        }

        .create-document-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .create-document-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .create-document-btn .button-text-short {
            display: none;
        }

        .sorting-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .sort-select {
            border: none;
            background: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        .sort-direction {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: #3498db;
            display: flex;
            align-items: center;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .sort-direction:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
            min-width: 150px;
        }

        .clear-filters-btn {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clear-filters-btn:hover {
            background: #7f8c8d;
        }

        /* Documents Grid */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .document-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            border: 1px solid #f1f3f4;
            display: flex;
            flex-direction: column;
            min-height: 340px; /* Slightly taller to accommodate search highlights */
            max-height: 480px; 
        }

        .document-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .document-preview {
            height: 140px;
            min-height: 140px; /* Ensure preview never shrinks below this */
            flex-shrink: 0; /* Prevent the preview from shrinking */
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .document-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .document-preview .pdf-icon {
            font-size: 48px;
            color: #e74c3c;
        }

        .document-preview .generic-icon {
            font-size: 48px;
            color: #95a5a6;
        }

        .document-info {
            padding: 16px;
            flex: 1; /* Take all available space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Ensure content doesn't overflow the card */
        }

        .document-header {
            margin-bottom: 8px;
        }

        .document-title-section {
            width: 100%;
        }

        .document-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .document-btn {
            background: none;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            text-decoration: none;
            width: 28px;
            height: 28px;
        }

        .document-btn:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }

        .document-btn .material-icons {
            font-size: 16px;
        }

        .view-btn {
            color: #3498db;
        }

        .view-btn:hover {
            color: #2980b9;
            border-color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .edit-btn {
            color: #f39c12;
        }

        .edit-btn:hover {
            color: #e67e22;
            border-color: #f39c12;
            background-color: rgba(243, 156, 18, 0.1);
        }

        .delete-btn {
            color: #e74c3c;
        }

        .delete-btn:hover {
            color: #c0392b;
            border-color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .document-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 8px 0;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .document-description {
            font-size: 14px;
            color: #7f8c8d;
            margin: 0 0 12px 0;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .document-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 8px;
        }

        .document-file-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .document-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 20px; /* Reserve space even when no tags */
        }

        .document-footer {
            margin-top: auto;
        }

        .document-tag {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Search Result Styles - Compact and lean */
        .search-highlight {
            margin: 4px 0 8px 0;
            font-size: 12px;
            max-height: 90px; 
            overflow: hidden; /* Hide excess content */
        }

        .search-highlight-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .search-highlight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .search-relevance-score {
            font-size: 10px;
            color: #95a5a6;
            background-color: rgba(149, 165, 166, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .search-highlight-text {
            color: #34495e;
            line-height: 1.4;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Allow up to 4 lines instead of 3 */
            line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        /* Structured match display - Compact and lean */
        .match-section {
            margin-bottom: 2px;
            display: inline-block;
            margin-right: 12px;
        }

        .match-section:last-child {
            margin-bottom: 0;
            margin-right: 0;
        }

        .match-type-label {
            font-weight: 600;
            color: #95a5a6;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-right: 4px;
        }

        .match-content {
            color: #34495e;
            font-size: 12px;
        }

        .search-match {
            font-weight: 700;
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.1);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .match-types {
            display: flex;
            gap: 6px;
            margin: 4px 0;
            flex-wrap: wrap;
        }

        /* Search Results Header */
        .search-results-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-results-text {
            color: #2c3e50;
            font-size: 14px;
        }

        .search-term {
            font-weight: 600;
            color: #3498db;
        }

        .clear-search-btn {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .clear-search-btn:hover {
            background: #7f8c8d;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }

        .pagination-info {
            color: #7f8c8d;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            background: white;
            border: 1px solid #e1e8ed;
            padding: 8px 12px;
            border-radius: 6px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .pagination-btn:hover:not(.disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-btn.current {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination-btn.disabled {
            background: #f8f9fa;
            color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 15px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* Success Message */
        .success-message {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(46, 204, 113, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.5s ease;
            transition: all 0.4s ease;
            overflow: hidden;
        }

        .success-message.fadeOut {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-width: 0;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.5s ease;
            transition: all 0.4s ease;
            overflow: hidden;
        }

        .error-message.fadeOut {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-width: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 1200px) {
            .content-container {
                padding: 25px !important;
                min-height: calc(100vh - 220px) !important;
            }
            
            .main-content {
                padding: 15px 10px !important;
            }
        }

        @media (max-width: 768px) {
            .content-container {
                padding: 20px !important;
                margin: 0;
                min-height: calc(100vh - 140px) !important;
                max-height: none !important;
            }
            
            .main-content {
                padding: 10px 5px !important;
                min-height: calc(100vh - 120px) !important;
            }

            .documents-header {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 20px;
            }

            .documents-actions {
                justify-content: space-between;
            }

            .documents-title {
                font-size: 24px;
            }

            .documents-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                min-height: 400px;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }

            .filter-select {
                min-width: auto;
            }

            .pagination-controls {
                flex-wrap: wrap;
            }
            
            /* Improve touch accessibility for tablets */
            .document-actions {
                gap: 8px;
            }

            .document-btn {
                width: 36px;
                height: 36px;
                padding: 8px;
                min-width: 36px;
                min-height: 36px;
            }

            .document-btn .material-icons {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .document-card {
                min-height: 400px; /* More space for mobile search results */
                max-height: 520px; /* Allow extra room for search highlights on mobile */
            }

            .document-preview {
                height: 160px; /* Consistent preview size for mobile */
                min-height: 160px; /* Ensure preview never shrinks */
                flex-shrink: 0; /* Prevent shrinking */
            }

            .pagination-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .create-document-btn .button-text-full {
                display: none;
            }

            .create-document-btn .button-text-short {
                display: none;
            }

            /* No need for complex header layout since buttons are moved to footer */
            .document-title {
                font-size: 15px; /* Slightly larger since no space competition */
                line-height: 1.3;
                -webkit-line-clamp: 2;
                line-clamp: 2;
            }

            /* Action buttons sized for mobile touch accessibility */
            .document-btn {
                width: 40px;
                height: 40px;
                padding: 10px;
                min-width: 40px;
                min-height: 40px;
            }

            .document-btn .material-icons {
                font-size: 18px;
            }
        }

        /* Filter Controls */
        .filter-controls {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(52, 152, 219, 0.1);
            display: flex;
            flex-direction: column;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 20px;
            width: 100%;
            cursor: pointer;
            user-select: none;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .filter-header:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .filter-collapse-icon {
            font-size: 20px;
            color: #7f8c8d;
            transition: transform 0.3s ease;
            margin-left: 8px;
        }

        .filter-collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .filter-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .filter-content.collapsed {
            max-height: 0;
            margin-bottom: 0;
            opacity: 0;
        }

        .filter-status {
            font-size: 14px;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .selected-count {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .clear-filters-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .clear-filters-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        .tags-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .filter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .filter-tag:not(.selected) {
            background: white;
            color: #2c3e50;
            border-color: #e1e8ed;
        }

        .filter-tag:not(.selected):hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }

        .filter-tag.selected {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .filter-tag.selected:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .filter-tag.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .filter-tag.disabled:hover {
            background: white !important;
            border-color: #e1e8ed !important;
            box-shadow: none !important;
        }

        .tag-color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .filter-limit-message {
            background: rgba(255, 193, 7, 0.1);
            color: #f39c12;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        /* Responsive filter layout */
        @media (max-width: 768px) {
            .filter-header {
                gap: 15px;
            }

            .filter-title {
                font-size: 15px;
            }

            .filter-status {
                font-size: 13px;
            }

            .clear-filters-btn {
                padding: 4px 8px;
                font-size: 11px;
                border-radius: 14px;
            }
        }
    </style>

    <div class="documents-container">
        {{if .SuccessMessage}}
        <div class="success-message">
            <span class="material-icons">check_circle</span>
            {{.SuccessMessage}}
        </div>
        {{end}}

                <div class="documents-header">
                    <h1 class="documents-title">My Documents</h1>
                    <div class="documents-actions">
                        <div class="sorting-controls">
                            <label for="sortBy" style="font-size: 14px; color: #7f8c8d;">Sort by:</label>
                            <select id="sortBy" class="sort-select" onchange="updateSorting(this.value)">
                                {{if .IsSearchResult}}
                                <option value="relevance" {{if eq .SortBy "relevance"}}selected{{end}}>Relevance</option>
                                {{end}}
                                <option value="title" {{if eq .SortBy "title"}}selected{{end}}>Title</option>
                                <option value="created_at" {{if eq .SortBy "created_at"}}selected{{end}}>Created</option>
                                <option value="modified_at" {{if eq .SortBy "modified_at"}}selected{{end}}>Modified</option>
                            </select>
                            <button class="sort-direction" onclick="toggleSortDirection()" title="{{if .SortAsc}}Sort Descending{{else}}Sort Ascending{{end}}">
                                <span class="material-icons">{{if .SortAsc}}arrow_upward{{else}}arrow_downward{{end}}</span>
                            </button>
                        </div>
                        <a href="/create-document" class="create-document-btn">
                            <span class="material-icons">add</span>
                            <span class="button-text-full">New Document</span>
                            <span class="button-text-short">New</span>
                        </a>
                    </div>
                </div>

                <!-- Search Results Info -->
                {{if .IsSearchResult}}
                <div class="search-results-info">
                    <div class="search-results-text">
                        Search results for <span class="search-term">"{{.SearchTerm}}"</span>
                        {{if .DeepSearch}}(deep search enabled){{end}}
                        - {{.TotalCount}} document{{if ne .TotalCount 1}}s{{end}} found
                    </div>
                    <a href="/documents" class="clear-search-btn">Clear Search</a>
                </div>
                {{end}}

                <!-- Filter Controls -->
                <div class="filter-controls">
                    <div class="filter-header" onclick="toggleFilterCollapse()">
                        <h3 class="filter-title">
                            <span class="material-icons">filter_list</span>
                            Filter by Tags
                            <span class="material-icons filter-collapse-icon expanded" id="filterCollapseIcon">keyboard_arrow_down</span>
                        </h3>
                        <div class="filter-status">
                            <span class="selected-count" id="tag-count">{{len .TagIds}}</span>
                            <span>of 3 selected</span>
                            {{if .TagIds}}
                                <button class="clear-filters-btn" onclick="clearFilters(); event.stopPropagation();">
                                    <span class="material-icons" style="font-size: 16px;">clear</span>
                                    Clear Filters
                                </button>
                            {{end}}
                        </div>
                    </div>
                    
                    <div class="filter-content" id="filterContent">
                        <div class="tags-filter-container" id="tagsFilterContainer">
                            {{range .AllTags}}
                            {{$isSelected := false}}
                            {{range $.TagIds}}{{if eq . $.Id}}{{$isSelected = true}}{{end}}{{end}}
                            <div class="filter-tag{{if $isSelected}} selected{{end}}" 
                                 data-tag-id="{{.Id}}" 
                                 onclick="toggleTagFilter('{{.Id}}')">
                                <div class="tag-color-dot" style="background-color: {{.Color}};"></div>
                                <span>{{.Name}}</span>
                            </div>
                            {{end}}
                        </div>
                        
                        <div class="filter-limit-message" id="filterLimitMessage" style="display: none;">
                            <span class="material-icons" style="font-size: 16px;">warning</span>
                            Maximum 3 tags can be selected for filtering
                        </div>
                    </div>
                </div>

                <!-- Documents Grid -->
                {{if .Documents}}
                    <div class="documents-grid">
                        {{range .Documents}}
                            <div class="document-card{{if .IsSearchResult}} search-result{{end}}">
                                <div class="document-preview">
                                    {{if .Preview}}
                                        {{if eq .Preview.PreviewType "application/pdf"}}
                                            <span class="material-icons pdf-icon">picture_as_pdf</span>
                                        {{else}}
                                            <img src="data:{{.Preview.PreviewType}};base64,{{base64 .Preview.PreviewData}}" alt="Document preview">
                                        {{end}}
                                    {{else}}
                                        <span class="material-icons generic-icon">description</span>
                                    {{end}}
                                </div>
                                <div class="document-info">
                                    <div class="document-header">
                                        <div class="document-title-section">
                                            <h3 class="document-title">{{.Title}}</h3>
                                        </div>
                                    </div>
                                    <p class="document-description">{{.Description}}</p>
                                    {{if .IsSearchResult}}
                                        {{if .HighlightedText}}
                                            <div class="search-highlight">
                                                <div class="search-highlight-header">
                                                    <div class="search-highlight-label">Match:</div>
                                                    <div class="search-relevance-score" title="Relevance Score">{{printf "%.2f" .RelevanceScore}}</div>
                                                </div>
                                                <div class="search-highlight-text" data-highlight-text="{{.HighlightedText}}"></div>
                                            </div>
                                        {{end}}
                                    {{end}}
                                    <div class="document-footer">
                                        <div class="document-meta">
                                            <span class="document-file-count">
                                                <span class="material-icons" style="font-size: 14px;">attach_file</span>
                                                {{.FileCount}} file{{if ne .FileCount 1}}s{{end}}
                                            </span>
                                            <span>{{.ModifiedAt.Format "2006-01-02 15:04:05"}}</span>
                                        </div>
                                        <div class="document-tags">
                                            {{range .Tags}}
                                                <span class="document-tag" style="background-color: {{.Color}}20; color: {{.Color}};">{{.Name}}</span>
                                            {{end}}
                                        </div>
                                        <div class="document-actions">
                                            <a href="/view-document?id={{.Id}}" class="document-btn view-btn" title="View Document">
                                                <span class="material-icons">visibility</span>
                                            </a>
                                            <a href="/edit-document?id={{.Id}}&returnTo=documents" class="document-btn edit-btn" title="Edit Document">
                                                <span class="material-icons">edit</span>
                                            </a>
                                            <button class="document-btn delete-btn" onclick="deleteDocument('{{.Id}}', '{{.Title}}')" title="Delete Document">
                                                <span class="material-icons">delete</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {{end}}
                    </div>
                {{else}}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <span class="material-icons" style="font-size: inherit;">description</span>
                        </div>
                        <div class="empty-state-title">No documents found</div>
                        <div class="empty-state-text">
                            {{if .TagIds}}
                                No documents match the selected filters.
                            {{else}}
                                You haven't created any documents yet.
                            {{end}}
                        </div>
                        <a href="/create-document" class="create-document-btn">
                            <span class="material-icons">add</span>
                            {{if .TagIds}}
                                Create new document
                            {{else}}
                                Create your first document
                            {{end}}
                        </a>
                    </div>
                {{end}}

                <!-- Pagination -->
                {{if gt .TotalPages 1}}
                    <div class="pagination-container">
                        <div class="pagination-info">
                            Showing {{if .Documents}}{{add (mul (sub .Page 1) .PageSize) 1}}-{{min (mul .Page .PageSize) .TotalCount}}{{else}}0{{end}} of {{.TotalCount}} documents
                        </div>
                        <div class="pagination-controls">
                            {{if .HasPrevious}}
                                <a href="?page={{sub .Page 1}}&sortBy={{.SortBy}}&sortAsc={{.SortAsc}}{{range .TagIds}}&tagIds={{.}}{{end}}" class="pagination-btn">Previous</a>
                            {{else}}
                                <span class="pagination-btn disabled">Previous</span>
                            {{end}}
                            
                            {{$currentPage := .Page}}
                            {{$totalPages := .TotalPages}}
                            {{$sortBy := .SortBy}}
                            {{$sortAsc := .SortAsc}}
                            {{$tagIds := .TagIds}}
                            
                            {{range $i := 1}}
                                {{if le $i $totalPages}}
                                    {{$start := max 1 (sub $currentPage 2)}}
                                    {{$end := min $totalPages (add $currentPage 2)}}
                                    
                                    {{if gt $start 1}}
                                        <a href="?page=1&sortBy={{$sortBy}}&sortAsc={{$sortAsc}}{{range $tagIds}}&tagIds={{.}}{{end}}" class="pagination-btn">1</a>
                                        {{if gt $start 2}}<span class="pagination-btn disabled">...</span>{{end}}
                                    {{end}}
                                    
                                    {{range $page := $start}}
                                        {{if le $page $end}}
                                            {{if eq $page $currentPage}}
                                                <span class="pagination-btn current">{{$page}}</span>
                                            {{else}}
                                                <a href="?page={{$page}}&sortBy={{$sortBy}}&sortAsc={{$sortAsc}}{{range $tagIds}}&tagIds={{.}}{{end}}" class="pagination-btn">{{$page}}</a>
                                            {{end}}
                                        {{end}}
                                    {{end}}
                                    
                                    {{if lt $end $totalPages}}
                                        {{if lt $end (sub $totalPages 1)}}<span class="pagination-btn disabled">...</span>{{end}}
                                        <a href="?page={{$totalPages}}&sortBy={{$sortBy}}&sortAsc={{$sortAsc}}{{range $tagIds}}&tagIds={{.}}{{end}}" class="pagination-btn">{{$totalPages}}</a>
                                    {{end}}
                                {{end}}
                            {{end}}
                            
                            {{if .HasNext}}
                                <a href="?page={{add .Page 1}}&sortBy={{.SortBy}}&sortAsc={{.SortAsc}}{{range .TagIds}}&tagIds={{.}}{{end}}" class="pagination-btn">Next</a>
                            {{else}}
                                <span class="pagination-btn disabled">Next</span>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            </div>
    </div>

    <script>
        // Tag filter functionality with 3-tag limit
        const MAX_TAGS = 3;
        let selectedTags = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize selected tags from current URL
            const urlParams = new URLSearchParams(window.location.search);
            const tagIds = urlParams.get('tagIds');
            if (tagIds) {
                selectedTags = tagIds.split(',').filter(id => id.trim() !== '');
            }
            updateTagFilterUI();
            
            // Initialize filter collapse state
            initializeFilterCollapse();
        });

        function initializeFilterCollapse() {
            // Check if filters are being used
            const hasActiveFilters = selectedTags.length > 0;
            
            // Start expanded if there are active filters, collapsed otherwise
            const shouldExpand = hasActiveFilters;
            
            const filterContent = document.getElementById('filterContent');
            const collapseIcon = document.getElementById('filterCollapseIcon');
            
            if (!shouldExpand) {
                filterContent.classList.add('collapsed');
                collapseIcon.classList.remove('expanded');
            }
        }

        function toggleFilterCollapse() {
            const filterContent = document.getElementById('filterContent');
            const collapseIcon = document.getElementById('filterCollapseIcon');
            
            if (filterContent.classList.contains('collapsed')) {
                // Expand
                filterContent.classList.remove('collapsed');
                collapseIcon.classList.add('expanded');
            } else {
                // Collapse
                filterContent.classList.add('collapsed');
                collapseIcon.classList.remove('expanded');
            }
        }

        function toggleTagFilter(tagId) {
            const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
            
            if (selectedTags.includes(tagId)) {
                // Remove tag from selection
                selectedTags = selectedTags.filter(id => id !== tagId);
                tagElement.classList.remove('selected');
            } else {
                // Add tag if under limit
                if (selectedTags.length < MAX_TAGS) {
                    selectedTags.push(tagId);
                    tagElement.classList.add('selected');
                } else {
                    // Show limit message
                    showLimitMessage();
                    return;
                }
            }
            
            updateTagFilterUI();
            applyTagFilters();
        }

        function updateTagFilterUI() {
            // Update count display
            const countElement = document.getElementById('tag-count');
            if (countElement) {
                countElement.textContent = selectedTags.length;
            }
            
            // Update tag states
            const allTags = document.querySelectorAll('.filter-tag');
            allTags.forEach(tag => {
                const tagId = tag.getAttribute('data-tag-id');
                const isSelected = selectedTags.includes(tagId);
                
                // Update visual state
                if (isSelected) {
                    tag.classList.add('selected');
                } else {
                    tag.classList.remove('selected');
                }
                
                // Disable non-selected tags if at limit
                if (selectedTags.length >= MAX_TAGS && !isSelected) {
                    tag.classList.add('disabled');
                } else {
                    tag.classList.remove('disabled');
                }
            });
            
            // Hide limit message when under limit
            if (selectedTags.length < MAX_TAGS) {
                hideLimitMessage();
            }
        }

        function showLimitMessage() {
            const message = document.getElementById('filterLimitMessage');
            if (message) {
                message.style.display = 'flex';
                setTimeout(() => {
                    hideLimitMessage();
                }, 3000);
            }
        }

        function hideLimitMessage() {
            const message = document.getElementById('filterLimitMessage');
            if (message) {
                message.style.display = 'none';
            }
        }

        // Helper function to clear success message parameters
        function clearSuccessMessageParams(urlParams) {
            urlParams.delete('created');
            urlParams.delete('updated');
            urlParams.delete('deleted');
        }

        function applyTagFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (selectedTags.length > 0) {
                urlParams.set('tagIds', selectedTags.join(','));
            } else {
                urlParams.delete('tagIds');
            }
            urlParams.set('page', '1'); // Reset to first page when filters change
            clearSuccessMessageParams(urlParams); // Clear success messages
            window.location.search = urlParams.toString();
        }

        function updateSorting(newSortBy) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('sortBy', newSortBy);
            urlParams.set('page', '1'); // Reset to first page when sorting changes
            clearSuccessMessageParams(urlParams); // Clear success messages
            window.location.search = urlParams.toString();
        }

        function toggleSortDirection() {
            const urlParams = new URLSearchParams(window.location.search);
            // Use the server-provided sort direction state instead of parsing URL
            const currentSortAsc = {{.SortAsc}};
            urlParams.set('sortAsc', (!currentSortAsc).toString());
            urlParams.set('page', '1'); // Reset to first page when sorting changes
            clearSuccessMessageParams(urlParams); // Clear success messages
            window.location.search = urlParams.toString();
        }

        function clearFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('tagIds');
            urlParams.set('page', '1');
            clearSuccessMessageParams(urlParams); // Clear success messages
            window.location.search = urlParams.toString();
        }

        // Auto-dismiss success message after 3 seconds
        const successMessage = document.querySelector('.success-message');
        if (successMessage) {
            setTimeout(() => {
                successMessage.classList.add('fadeOut');
                setTimeout(() => {
                    successMessage.remove();
                }, 400);
            }, 3000);
        }

        // Function to show error messages consistently with success messages
        function showErrorMessage(message) {
            // Remove any existing error message
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <span class="material-icons">error</span>
                ${message}
            `;

            // Insert at the top of the documents container, after any success message
            const documentsContainer = document.querySelector('.documents-container');
            const successMessage = documentsContainer.querySelector('.success-message');
            if (successMessage) {
                documentsContainer.insertBefore(errorDiv, successMessage.nextSibling);
            } else {
                documentsContainer.insertBefore(errorDiv, documentsContainer.firstChild);
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                errorDiv.classList.add('fadeOut');
                setTimeout(() => {
                    errorDiv.remove();
                }, 400);
            }, 5000);
        }

        // Delete document function
        function deleteDocument(documentId, documentTitle) {
            // Store reference to the delete button for later use
            const deleteButton = event.target.closest('.delete-btn');
            
            // Show custom confirmation modal (similar to secrets page)
            showConfirmModal(
                'Confirm Deletion',
                'Are you sure you want to delete this document?',
                documentTitle,
                function() {
                    // User confirmed - proceed with deletion
                    performDocumentDelete(documentId, documentTitle, deleteButton);
                },
                'Delete Document', // Custom confirm button text
                'This action cannot be undone. All files associated with this document will also be deleted.' // Warning text for destructive action
            );
        }

        function performDocumentDelete(documentId, documentTitle, deleteButton) {
            // Disable the delete button to prevent double-clicks
            const originalContent = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<span class="material-icons">hourglass_empty</span>';
            deleteButton.style.opacity = '0.6';
            deleteButton.style.cursor = 'not-allowed';

            // Make AJAX request to delete the document
            fetch(`/documents/${documentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            })
            .then(data => {
                if (data.success) {
                    // Success: redirect to show success message
                    window.location.href = '/documents?deleted=1';
                } else {
                    // Handle server-side error
                    alert(`Error deleting document: ${data.error || 'Unknown error'}`);
                    // Re-enable the button
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    deleteButton.style.opacity = '1';
                    deleteButton.style.cursor = 'pointer';
                }
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert(`Error deleting document: ${error.message}`);
                // Re-enable the button
                deleteButton.disabled = false;
                deleteButton.innerHTML = originalContent;
                deleteButton.style.opacity = '1';
                deleteButton.style.cursor = 'pointer';
            });
        }

        // Function to render highlighted text from data attributes
        function renderHighlightedText() {
            const highlightElements = document.querySelectorAll('.search-highlight-text[data-highlight-text]');
            
            highlightElements.forEach(element => {
                const highlightText = element.getAttribute('data-highlight-text');
                if (highlightText && highlightText.trim()) {
                    // Parse and structure the highlighted text by match types
                    const structuredMatches = parseMatchTypes(highlightText);
                    
                    if (structuredMatches.length > 0) {
                        element.innerHTML = structuredMatches.map(match => {
                            const highlightedContent = match.content.replace(/\*\*([^*]+)\*\*/g, '<strong class="search-match">$1</strong>');
                            return `<span class="match-section"><span class="match-type-label">${match.type}:</span> <span class="match-content">${highlightedContent}</span></span>`;
                        }).join(' ');
                    } else {
                        // Fallback: just highlight the text without structure
                        const highlighted = highlightText.replace(/\*\*([^*]+)\*\*/g, '<strong class="search-match">$1</strong>');
                        element.innerHTML = highlighted;
                    }
                }
            });
        }
        
        // Function to parse match types from highlighted text
        function parseMatchTypes(text) {
            const matches = [];
            // Split by pipe symbol to get individual match sections
            const sections = text.split('|').map(s => s.trim()).filter(s => s);
            
            for (const section of sections) {
                console.log('Processing section:', section);
                // Look for patterns like "Title: some text", "Description: some text", etc.
                const match = section.match(/^([^:]+):\s*(.+)/s);
                if (match) {
                    matches.push({
                        type: match[1].trim(),
                        content: match[2].trim()
                    });
                } else if (section.trim()) {
                    // If no type prefix, treat as generic content
                    matches.push({
                        type: 'Match',
                        content: section.trim()
                    });
                }
            }
            
            return matches;
        }

        // Initialize highlighting when page loads
        document.addEventListener('DOMContentLoaded', function() {
            renderHighlightedText();
            
            // Set search type to documents on the documents page
            const searchTypeDropdown = document.getElementById('searchTypeDropdown');
            if (searchTypeDropdown) {
                searchTypeDropdown.value = 'documents';
                // Trigger the change event to update icon and show deep search toggle
                if (typeof updateDropdownIcon === 'function') {
                    updateDropdownIcon();
                }
                if (typeof toggleDeepSearchToggle === 'function') {
                    toggleDeepSearchToggle();
                }
            }
        });
    </script>

{{template "footer" .}}
